<!DOCTYPE html>
<html>

<head>
	<!--Título del documento-->
 	<title>wmspnoa5-GETFEATUREINFO.html</title>

	<!--Cargar openlayers desde internet-->
 	<link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css" type="text/css">
	<script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>


	<!--Cargar el selector de capas o layerswitcher desde internet-->
 	<link rel="stylesheet" href="https://unpkg.com/ol-layerswitcher@3.3.0/src/ol-layerswitcher.css" />
 	<script src="https://unpkg.com/ol-layerswitcher@3.3.0"></script>

 	<!--Cargar librerías desde internet para transformar coordenadas de 25830 a 4326-->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4-src.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>
	
	
	<!--Clases CSS-->
	<style>

		/*estilo del recuadro del mapa*/
 		#map {
 			width: 1080px;
 			height: 720px;
 			box-shadow: 5px 5px 5px #888;
		}

		/*estilo de las coordenadas del mouse*/
 		.coordenadas {
 			position: absolute;
 			right: 15px;
			bottom: 15px;
 			color: #fff;
 			z-index: 50;
 			text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
 		}

		/*estilo del overview-map*/
 		.ol-overviewmap {
 			bottom: 35px;
 		}
 	</style>
</head>


<!--Cuerpo del documento donde se visualizará nuestra página web-->
<body>

	<!--Objetos HTML que almacenan el contenido de la página-->
	<!--Caja del mapa-->
 	<div id="map"></div>
	
	<!--Ventana con la información de las entidades-->
 	<div id="overlay" style="background-color: rgb(253, 173, 0); background-size: 250px 250px ; border-radius: 5px; border: 10px solid black; padding: 5px 10px;">
	
	<!--Script de JavaScript en el que se configuran los objetos <div> anteriores-->	
	<script>

		//PROYECCIONES
 		//Agregar proyección 25830 para que Openlayers la reconozca (Openlayers está en 4326)
 		proj4.defs("EPSG:25830", "+proj=utm +zone=30 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");

 		//Registro de la proyección cargada anteriormente para que la librería proj4 pueda acceder a ella y realizar transformaciones
 		ol.proj.proj4.register(proj4);

 		//Variable que define la proyección de nuestras capas 
 		var projection = new ol.proj.Projection({
 			code: 'EPSG:25830', 
 			units: 'm'
		});

		//Objeto con la proyección 25830
 		var proj25830 = ol.proj.get('EPSG:25830');
 		
		//Capas del mapa
		var pnoa =
 			new ol.layer.Image({
 				title: 'PNOA',
 				source: new ol.source.ImageWMS({
 					url: 'http://www.ign.es/wms-inspire/pnoa-ma',
 					params: {
						'LAYERS': 'OI.MosaicElement,OI.OrthoimageCoverage'
					},
				visible: true,
 				})
			});

		
		var osm =
			new ol.layer.Tile({
 				visible: true,
 				title: 'OSM',
 				source: new ol.source.OSM()
			});


		var catastro =
			new ol.layer.Image({
				title: 'CATASTRO',
				opacity: 0.5,
				source: new ol.source.ImageWMS({
					url: 'https://ovc.catastro.meh.es/Cartografia/WMS/ServidorWMS.aspx?',
					params: {
						'LAYERS': ['Catastro'],'VERSION': "1.1.1",
					// 'REQUEST': "GetCapabilities"
					},
				visible: true,
				})
			});

		var siose =
 			new ol.layer.Image({
 				title: 'SIOSE',
 				opacity: 0.5,
 				source: new ol.source.ImageWMS({
 					url: 'http://servicios.idee.es/wms-inspire/ocupacion-suelo?',
 					params: {
 						'LAYERS':'LU.ExistingLandUse,LC.LandCoverSurfaces'
 					},
 				visible: true,
 				})
 			});

		var bingmaps =
			new ol.layer.Tile({
 				visible: true,
 				preload: Infinity,
 				title: 'Bing Aerial',
 				source: new ol.source.BingMaps({
 					key: 'AlTSEdbsoNlnn7NvH59EkaGnqZUguWGRjM52Sspfvvj3iT5wdduDNZ2yYJw_mD82',
 					imagerySet: 'Aerial'
 				})
 			});
	 

		// Variables para el control de capas
		var baselayers = new ol.layer.Group({
 			title: 'Mapas base',
 			layers: [pnoa,bingmaps,osm]
 		});
 
		var overlays = new ol.layer.Group({
 			title: 'Capas temáticas',
 			layers: [catastro,siose]
 		});


		//Configuración de la caja del mapa
		var map = new ol.Map({
			layers: [baselayers,overlays], //objetos con las capas
			target: 'map', //objeto <div> en el que se insertará el mapa
			view: new ol.View({
				center: [265405 , 4283148],
				zoom: 5,
				projection: projection	//proyección definida anteriormente
			}),

			//Elementos interactivos del mapa
			controls: [

				//Mostrar las coordenadas del ratón
				new ol.control.MousePosition({
					coordinateFormat: ol.coordinate.createStringXY(3),
					projection: 'EPSG:25830',
					className: 'coordenadas' //clase CSS en la que configuramos su diseño
				}),

				//Controles de zoom
				new ol.control.ZoomSlider(),
				new ol.control.Zoom(),
				new ol.control.ZoomToExtent({
					extent: ol.proj.transformExtent([-21.895752,31.531726,-0.988770,40.229218],
						'EPSG:4326',
						'EPSG:25830'
					),
				}),

				//Barra de escala
				new ol.control.ScaleLine(),

				//Minimapa
				new ol.control.OverviewMap({
					view: new ol.View({
						layers : [pnoa],
						projection: projection
					}) 
				})
			]
		});

		//Configurar el selector de capas
		var layerSwitcher = new ol.control.LayerSwitcher({
 			tipLabel: 'Leyenda'
 		});

		//Añade a la caja del mapa el selector de capas
 		map.addControl(layerSwitcher); 
		layerSwitcher.showPanel();

		//Al iniciar, obtener en pantalla la vista del mapa transformando las coordenadas legibles por Openlayers (4326) a las coordenadas 
		//de la vista del mapa y de las capas cargadas (25830)
 		map.getView().fit(ol.proj.transformExtent([-28.256836,26.549223,5.229492,44.653024],'EPSG:4326', 'EPSG:25830'), map.getSize()
 		); 

		//OBTENCIÓN DE INFORMACIÓN DE LAS ENTIDADES 
		//Configuración del objeto <div> 'overlay' en el que se mostrará la info de la entidad seleccionada 
 		var overlay = new ol.Overlay({
 			element: document.getElementById('overlay'), 
 			positioning: 'bottom-center'
 		});

		//Hacer clickable la caja del mapa 
 		map.on('singleclick', function(evt) {
 			var element = overlay.getElement();
 			element.innerHTML = '';
 			var viewResolution = (map.getView().getResolution());
 			var url = catastro.getSource().getGetFeatureInfoUrl(evt.coordinate, viewResolution,'EPSG:25830',{'INFO_FORMAT': 'text/html'} 
 			);
 			if (url) {
 				element.innerHTML ='<iframe seamless src="' + url + '" border="0"></iframe>';
 			}
			console.info(element);
			overlay.setPosition(evt.coordinate);
			map.addOverlay(overlay); 
		});

 	</script>
</body>
</html>